// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.28.0
// source: data_retention_properties.sql

package gen

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const createDataRetentionProperties = `-- name: CreateDataRetentionProperties :one
INSERT INTO data_retention_properties (
    data_extension_id, data_retention_period_length, data_retention_period_unit_of_measure,
    is_delete_at_end_of_retention_period, is_row_based_retention, is_reset_retention_period_on_import
) VALUES ($1, $2, $3, $4, $5, $6)
RETURNING data_extension_id, data_retention_period_length, data_retention_period_unit_of_measure, is_delete_at_end_of_retention_period, is_row_based_retention, is_reset_retention_period_on_import, created_at, updated_at, last_api_update_at, last_api_update_status, last_api_update_error, api_update_retry_count
`

type CreateDataRetentionPropertiesParams struct {
	DataExtensionID                  string `json:"data_extension_id"`
	DataRetentionPeriodLength        int32  `json:"data_retention_period_length"`
	DataRetentionPeriodUnitOfMeasure int32  `json:"data_retention_period_unit_of_measure"`
	IsDeleteAtEndOfRetentionPeriod   bool   `json:"is_delete_at_end_of_retention_period"`
	IsRowBasedRetention              bool   `json:"is_row_based_retention"`
	IsResetRetentionPeriodOnImport   bool   `json:"is_reset_retention_period_on_import"`
}

func (q *Queries) CreateDataRetentionProperties(ctx context.Context, db DBTX, arg CreateDataRetentionPropertiesParams) (*DataRetentionProperties, error) {
	row := db.QueryRow(ctx, createDataRetentionProperties,
		arg.DataExtensionID,
		arg.DataRetentionPeriodLength,
		arg.DataRetentionPeriodUnitOfMeasure,
		arg.IsDeleteAtEndOfRetentionPeriod,
		arg.IsRowBasedRetention,
		arg.IsResetRetentionPeriodOnImport,
	)
	var i DataRetentionProperties
	err := row.Scan(
		&i.DataExtensionID,
		&i.DataRetentionPeriodLength,
		&i.DataRetentionPeriodUnitOfMeasure,
		&i.IsDeleteAtEndOfRetentionPeriod,
		&i.IsRowBasedRetention,
		&i.IsResetRetentionPeriodOnImport,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastApiUpdateAt,
		&i.LastApiUpdateStatus,
		&i.LastApiUpdateError,
		&i.ApiUpdateRetryCount,
	)
	return &i, err
}

const deleteDataRetentionProperties = `-- name: DeleteDataRetentionProperties :exec
DELETE FROM data_retention_properties
WHERE data_extension_id = $1
`

func (q *Queries) DeleteDataRetentionProperties(ctx context.Context, db DBTX, dataExtensionID string) error {
	_, err := db.Exec(ctx, deleteDataRetentionProperties, dataExtensionID)
	return err
}

const getDataExtensionsNeedingRetentionUpdate = `-- name: GetDataExtensionsNeedingRetentionUpdate :many
SELECT drp.data_extension_id, drp.data_retention_period_length, drp.data_retention_period_unit_of_measure, drp.is_delete_at_end_of_retention_period, drp.is_row_based_retention, drp.is_reset_retention_period_on_import, drp.created_at, drp.updated_at, drp.last_api_update_at, drp.last_api_update_status, drp.last_api_update_error, drp.api_update_retry_count, de.name as data_extension_name
FROM data_retention_properties drp
INNER JOIN data_extensions de ON drp.data_extension_id = de.id
WHERE drp.last_api_update_status IN ('pending', 'failed')
  AND (drp.api_update_retry_count < 5 OR drp.api_update_retry_count IS NULL)
ORDER BY drp.last_api_update_at ASC NULLS FIRST, drp.api_update_retry_count ASC
LIMIT $1
`

type GetDataExtensionsNeedingRetentionUpdateRow struct {
	DataExtensionID                  string             `json:"data_extension_id"`
	DataRetentionPeriodLength        int32              `json:"data_retention_period_length"`
	DataRetentionPeriodUnitOfMeasure int32              `json:"data_retention_period_unit_of_measure"`
	IsDeleteAtEndOfRetentionPeriod   bool               `json:"is_delete_at_end_of_retention_period"`
	IsRowBasedRetention              bool               `json:"is_row_based_retention"`
	IsResetRetentionPeriodOnImport   bool               `json:"is_reset_retention_period_on_import"`
	CreatedAt                        pgtype.Timestamptz `json:"created_at"`
	UpdatedAt                        pgtype.Timestamptz `json:"updated_at"`
	LastApiUpdateAt                  pgtype.Timestamptz `json:"last_api_update_at"`
	LastApiUpdateStatus              pgtype.Text        `json:"last_api_update_status"`
	LastApiUpdateError               pgtype.Text        `json:"last_api_update_error"`
	ApiUpdateRetryCount              int32              `json:"api_update_retry_count"`
	DataExtensionName                string             `json:"data_extension_name"`
}

func (q *Queries) GetDataExtensionsNeedingRetentionUpdate(ctx context.Context, db DBTX, limit int32) ([]*GetDataExtensionsNeedingRetentionUpdateRow, error) {
	rows, err := db.Query(ctx, getDataExtensionsNeedingRetentionUpdate, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []*GetDataExtensionsNeedingRetentionUpdateRow
	for rows.Next() {
		var i GetDataExtensionsNeedingRetentionUpdateRow
		if err := rows.Scan(
			&i.DataExtensionID,
			&i.DataRetentionPeriodLength,
			&i.DataRetentionPeriodUnitOfMeasure,
			&i.IsDeleteAtEndOfRetentionPeriod,
			&i.IsRowBasedRetention,
			&i.IsResetRetentionPeriodOnImport,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.LastApiUpdateAt,
			&i.LastApiUpdateStatus,
			&i.LastApiUpdateError,
			&i.ApiUpdateRetryCount,
			&i.DataExtensionName,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getDataRetentionPropertiesByDataExtensionID = `-- name: GetDataRetentionPropertiesByDataExtensionID :one
SELECT data_extension_id, data_retention_period_length, data_retention_period_unit_of_measure, is_delete_at_end_of_retention_period, is_row_based_retention, is_reset_retention_period_on_import, created_at, updated_at, last_api_update_at, last_api_update_status, last_api_update_error, api_update_retry_count FROM data_retention_properties
WHERE data_extension_id = $1
`

func (q *Queries) GetDataRetentionPropertiesByDataExtensionID(ctx context.Context, db DBTX, dataExtensionID string) (*DataRetentionProperties, error) {
	row := db.QueryRow(ctx, getDataRetentionPropertiesByDataExtensionID, dataExtensionID)
	var i DataRetentionProperties
	err := row.Scan(
		&i.DataExtensionID,
		&i.DataRetentionPeriodLength,
		&i.DataRetentionPeriodUnitOfMeasure,
		&i.IsDeleteAtEndOfRetentionPeriod,
		&i.IsRowBasedRetention,
		&i.IsResetRetentionPeriodOnImport,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastApiUpdateAt,
		&i.LastApiUpdateStatus,
		&i.LastApiUpdateError,
		&i.ApiUpdateRetryCount,
	)
	return &i, err
}

const resetDataRetentionAPIUpdateStatus = `-- name: ResetDataRetentionAPIUpdateStatus :one
UPDATE data_retention_properties
SET last_api_update_status = 'pending',
    last_api_update_error = NULL,
    api_update_retry_count = 0,
    updated_at = CURRENT_TIMESTAMP
WHERE data_extension_id = $1
RETURNING data_extension_id, data_retention_period_length, data_retention_period_unit_of_measure, is_delete_at_end_of_retention_period, is_row_based_retention, is_reset_retention_period_on_import, created_at, updated_at, last_api_update_at, last_api_update_status, last_api_update_error, api_update_retry_count
`

func (q *Queries) ResetDataRetentionAPIUpdateStatus(ctx context.Context, db DBTX, dataExtensionID string) (*DataRetentionProperties, error) {
	row := db.QueryRow(ctx, resetDataRetentionAPIUpdateStatus, dataExtensionID)
	var i DataRetentionProperties
	err := row.Scan(
		&i.DataExtensionID,
		&i.DataRetentionPeriodLength,
		&i.DataRetentionPeriodUnitOfMeasure,
		&i.IsDeleteAtEndOfRetentionPeriod,
		&i.IsRowBasedRetention,
		&i.IsResetRetentionPeriodOnImport,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastApiUpdateAt,
		&i.LastApiUpdateStatus,
		&i.LastApiUpdateError,
		&i.ApiUpdateRetryCount,
	)
	return &i, err
}

const updateDataRetentionAPIUpdateStatus = `-- name: UpdateDataRetentionAPIUpdateStatus :one
UPDATE data_retention_properties
SET last_api_update_at = CURRENT_TIMESTAMP,
    last_api_update_status = $1::VARCHAR,
    last_api_update_error = $2,
    api_update_retry_count = CASE 
        WHEN $1::VARCHAR = 'failed' THEN api_update_retry_count + 1
        WHEN $1::VARCHAR = 'succeeded' THEN 0
        ELSE api_update_retry_count
    END,
    -- Update retention properties when status is 'succeeded'
    data_retention_period_length = CASE 
        WHEN $1::VARCHAR = 'succeeded' THEN $3
        ELSE data_retention_period_length
    END,
    data_retention_period_unit_of_measure = CASE 
        WHEN $1::VARCHAR = 'succeeded' THEN $4
        ELSE data_retention_period_unit_of_measure
    END,
    is_row_based_retention = CASE 
        WHEN $1::VARCHAR = 'succeeded' THEN $5
        ELSE is_row_based_retention
    END,
    updated_at = CURRENT_TIMESTAMP
WHERE data_extension_id = $6
RETURNING data_extension_id, data_retention_period_length, data_retention_period_unit_of_measure, is_delete_at_end_of_retention_period, is_row_based_retention, is_reset_retention_period_on_import, created_at, updated_at, last_api_update_at, last_api_update_status, last_api_update_error, api_update_retry_count
`

type UpdateDataRetentionAPIUpdateStatusParams struct {
	LastApiUpdateStatus              string      `json:"last_api_update_status"`
	LastApiUpdateError               pgtype.Text `json:"last_api_update_error"`
	DataRetentionPeriodLength        int32       `json:"data_retention_period_length"`
	DataRetentionPeriodUnitOfMeasure int32       `json:"data_retention_period_unit_of_measure"`
	IsRowBasedRetention              bool        `json:"is_row_based_retention"`
	DataExtensionID                  string      `json:"data_extension_id"`
}

func (q *Queries) UpdateDataRetentionAPIUpdateStatus(ctx context.Context, db DBTX, arg UpdateDataRetentionAPIUpdateStatusParams) (*DataRetentionProperties, error) {
	row := db.QueryRow(ctx, updateDataRetentionAPIUpdateStatus,
		arg.LastApiUpdateStatus,
		arg.LastApiUpdateError,
		arg.DataRetentionPeriodLength,
		arg.DataRetentionPeriodUnitOfMeasure,
		arg.IsRowBasedRetention,
		arg.DataExtensionID,
	)
	var i DataRetentionProperties
	err := row.Scan(
		&i.DataExtensionID,
		&i.DataRetentionPeriodLength,
		&i.DataRetentionPeriodUnitOfMeasure,
		&i.IsDeleteAtEndOfRetentionPeriod,
		&i.IsRowBasedRetention,
		&i.IsResetRetentionPeriodOnImport,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastApiUpdateAt,
		&i.LastApiUpdateStatus,
		&i.LastApiUpdateError,
		&i.ApiUpdateRetryCount,
	)
	return &i, err
}

const updateDataRetentionProperties = `-- name: UpdateDataRetentionProperties :one
UPDATE data_retention_properties
SET data_retention_period_length = $2,
    data_retention_period_unit_of_measure = $3,
    is_delete_at_end_of_retention_period = $4,
    is_row_based_retention = $5,
    is_reset_retention_period_on_import = $6
WHERE data_extension_id = $1
RETURNING data_extension_id, data_retention_period_length, data_retention_period_unit_of_measure, is_delete_at_end_of_retention_period, is_row_based_retention, is_reset_retention_period_on_import, created_at, updated_at, last_api_update_at, last_api_update_status, last_api_update_error, api_update_retry_count
`

type UpdateDataRetentionPropertiesParams struct {
	DataExtensionID                  string `json:"data_extension_id"`
	DataRetentionPeriodLength        int32  `json:"data_retention_period_length"`
	DataRetentionPeriodUnitOfMeasure int32  `json:"data_retention_period_unit_of_measure"`
	IsDeleteAtEndOfRetentionPeriod   bool   `json:"is_delete_at_end_of_retention_period"`
	IsRowBasedRetention              bool   `json:"is_row_based_retention"`
	IsResetRetentionPeriodOnImport   bool   `json:"is_reset_retention_period_on_import"`
}

func (q *Queries) UpdateDataRetentionProperties(ctx context.Context, db DBTX, arg UpdateDataRetentionPropertiesParams) (*DataRetentionProperties, error) {
	row := db.QueryRow(ctx, updateDataRetentionProperties,
		arg.DataExtensionID,
		arg.DataRetentionPeriodLength,
		arg.DataRetentionPeriodUnitOfMeasure,
		arg.IsDeleteAtEndOfRetentionPeriod,
		arg.IsRowBasedRetention,
		arg.IsResetRetentionPeriodOnImport,
	)
	var i DataRetentionProperties
	err := row.Scan(
		&i.DataExtensionID,
		&i.DataRetentionPeriodLength,
		&i.DataRetentionPeriodUnitOfMeasure,
		&i.IsDeleteAtEndOfRetentionPeriod,
		&i.IsRowBasedRetention,
		&i.IsResetRetentionPeriodOnImport,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastApiUpdateAt,
		&i.LastApiUpdateStatus,
		&i.LastApiUpdateError,
		&i.ApiUpdateRetryCount,
	)
	return &i, err
}
